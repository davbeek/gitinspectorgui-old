<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
    </style>
</head>

<body>
    <div style="margin-right: auto; margin-left: 0;">
        <div class="sticky" id="tabRow" style="overflow-x: auto;">
            <ul class="nav nav-tabs flex-nowrap" id="tab-buttons">
                <li class="nav-item">
                    <button class="nav-link active" id="authors-tab" data-bs-toggle="tab"
                        data-bs-target="#authors">Authors</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="authors-files-tab" data-bs-toggle="tab"
                        data-bs-target="#authors-files">Authors-Files</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="files-authors-tab" data-bs-toggle="tab"
                        data-bs-target="#files-authors">Files-Authors</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="files-tab" data-bs-toggle="tab" data-bs-target="#files">Files</button>
                </li>
            </ul>
        </div>
        <div class="tab-content" id="tab-contents">
            <div class="tab-pane fade show active" id="authors"></div>
            <div class="tab-pane fade" id="authors-files"></div>
            <div class="tab-pane fade" id="files-authors"></div>
            <div class="tab-pane fade" id="files"></div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Function to dynamically load the CSS content from the global variable css_code
        function loadCustomCSS() {
            var cssCode = `{{ css_code | safe }}`;
            var styleTag = document.querySelector('style');
            if (styleTag) {
                styleTag.innerHTML = cssCode;
            } else {
                styleTag = document.createElement('style');
                styleTag.innerHTML = cssCode;
                document.head.appendChild(styleTag);
            }
        }

        // Call the function to load the custom CSS
        loadCustomCSS();
    </script>

    <script>
        // Adjust the top position of the header rows based on the height of the tab row
        window.addEventListener('load', function () {
            var tabRow = document.getElementById('tabRow');
            var headerRows = document.querySelectorAll('.headerRow');
            var tabRowHeight = tabRow.offsetHeight;
            headerRows.forEach(function (headerRow) {
                headerRow.style.top = tabRowHeight + 'px';
            });
        });
    </script>

    <script>
        // Function to update the visibility of rows based on the state of the buttons:
        // .blame-exclusions-button, .blame-empty-lines-button, and .hide-colors-button
        document.addEventListener("DOMContentLoaded", function () {

            const updateRows = () => {
                document.querySelectorAll('table').forEach(table => {
                    const exclusionsButton = table.querySelector('.blame-exclusions-button');
                    const emptyLinesButton = table.querySelector('.blame-empty-lines-button');
                    const hideColorsButton = table.querySelector('.hide-colors-button');

                    const isExclusionsPressed = exclusionsButton ? exclusionsButton.classList.contains('pressed') : false;
                    const isEmptyLinesPressed = emptyLinesButton ? emptyLinesButton.classList.contains('pressed') : false;
                    const isHideColorsPressed = hideColorsButton ? hideColorsButton.classList.contains('pressed') : false;

                    const rows = table.querySelectorAll('tbody tr');
                    rows.forEach(row => {
                        const codeCell = row.querySelector('.code-col');
                        const firstCell = row.cells[0];
                        const secondCell = row.cells[1];
                        const isEmptyLine = codeCell && codeCell.textContent.trim() === '';
                        const isExcludedAuthor = firstCell && secondCell && firstCell.textContent.trim() === '0' && !secondCell.textContent.includes('*');

                        row.style.display = (isExcludedAuthor && isExclusionsPressed)
                            || (isEmptyLine && isEmptyLinesPressed) ? 'none' : '';

                        if (isHideColorsPressed) {
                            row.classList.add('hide-colors');
                        } else {
                            row.classList.remove('hide-colors');
                        }
                    });
                });
            };

            const addEventListenersToButtons = () => {
                document.querySelectorAll('.blame-empty-lines-button, .blame-exclusions-button, .hide-colors-button').forEach(button => {
                    if (!button.classList.contains('hide-colors-button')) {
                        // Set initial state based on the presence of the 'pressed' class
                        updateRows()
                    };

                    button.onclick = function () {
                        button.classList.toggle('pressed');
                        updateRows();
                    };
                });
            };

            // Use MutationObserver to watch for changes in the DOM and add event listeners to the buttons
            const observer = new MutationObserver((mutationsList) => {
                for (const mutation of mutationsList) {
                    if (mutation.type === 'childList') {
                        addEventListenersToButtons();
                    }
                }
            });

            observer.observe(document.body, { childList: true, subtree: true });

            // Initial call to add event listeners to existing buttons
            addEventListenersToButtons();
        });
    </script>
    <script>
        // Function to add event listeners for tab activation and radio button clicks
        document.addEventListener("DOMContentLoaded", function () {
            // Function to click the first radio button in the active tab
            function clickFirstRadioButton(tabContent) {
                const firstRadioButton = tabContent.querySelector('input[type="radio"]');
                if (firstRadioButton) {
                    firstRadioButton.click();
                }
            }

            // Add event listener for tab activation
            const tabs = document.querySelectorAll('.nav-link[data-bs-toggle="tab"]');
            const activatedTabs = new Set();

            tabs.forEach(tab => {
                tab.addEventListener('shown.bs.tab', function (event) {
                    const targetId = event.target.getAttribute('data-bs-target');
                    const tabContent = document.querySelector(targetId);

                    if (!activatedTabs.has(targetId)) {
                        clickFirstRadioButton(tabContent);
                        activatedTabs.add(targetId);
                    }
                });
            });

            // Initial click for the first radio button in the initially active tab
            const initialActiveTab = document.querySelector('.nav-link.active');
            if (initialActiveTab) {
                const initialTargetId = initialActiveTab.getAttribute('data-bs-target');
                const initialTabContent = document.querySelector(initialTargetId);
                clickFirstRadioButton(initialTabContent);
                activatedTabs.add(initialTargetId);
            }

            // Add event listener for radio button clicks in each blame-container
            var blameContainers = document.querySelectorAll('.blame-container');
            blameContainers.forEach(function (blameContainer) {
                var radioButtons = blameContainer.querySelectorAll('.radio-button');
                var tableContainer = blameContainer.querySelector('.table-container');
                radioButtons.forEach(function (radioButton) {
                    radioButton.addEventListener('click', function () {
                        // Hide all tables in the .table-container
                        tableContainer.querySelectorAll('table').forEach(table => table.style.display = 'none');

                        // Check if the table is already in the DOM using its table id
                        const tableId = radioButton.id.replace('button-', '');
                        const existingTable = tableContainer.querySelector(`table#${tableId}`);

                        if (existingTable) {
                            // Show the existing table
                            existingTable.style.display = '';
                        } else {
                            // Fetch and insert the table if not already in the DOM
                            console.log(`Fetching table with id: ${tableId}`);
                            fetch(`/load-table/${tableId}`)
                                .then(response => response.text())
                                .then(html => {
                                    const tempDiv = document.createElement('div');
                                    tempDiv.innerHTML = html;
                                    const table = tempDiv.querySelector('table');
                                    table.id = tableId; // Ensure the table has the correct id
                                    tableContainer.appendChild(table);
                                })
                                .catch(error => console.error('Error loading table:', error));
                        }
                    });
                });
            });
        });
    </script>
    <script>
        // Function to truncate the length of tab names longer than 20 characters, but
        // only if the tab row height exceeds 3 times the default text height.
        document.addEventListener("DOMContentLoaded", function () {
            const tabRow = document.getElementById('tabRow');
            const tabs = document.querySelectorAll('.nav-link');
            const defaultTextHeight = tabs[0].offsetHeight;

            if (tabRow.offsetHeight > 3 * defaultTextHeight) {
                tabs.forEach(tab => {
                    const fullText = tab.textContent;
                    if (fullText.length > 20) {
                        tab.textContent = fullText.substring(0, 20) + '...';
                        tab.setAttribute('title', fullText);
                    }
                });
            }
        });
    </script>
    <script>
        // Set the base URL for the Flask server
        document.addEventListener("DOMContentLoaded", function () {
            const baseUrl = window.location.origin;
            console.log(`Base URL: ${baseUrl}`);
            // Use the base URL in your fetch requests or other dynamic URLs
        });
    </script>
    <script>
        let serverActive = true;

        // Increment the tab count when the page loads
        window.addEventListener('load', function () {
            fetch('/increment-tabs', { method: 'POST' });
        });

        // Decrement the tab count when the page unloads
        window.addEventListener('beforeunload', function () {
            if (serverActive) {
                navigator.sendBeacon('/decrement-tabs');
            }
        });
    </script>
</body>

</html>
